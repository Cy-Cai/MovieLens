---
title: "Recommendation System"
author: "Cyrus Cai"
date: "3/30/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tidyverse)
load("../rda/edx.rda")

load("../rda/train_set.rda")
load("../rda/test_set.rda")
```

# 1 Introduction
With the assumption that historical data contains inights for the future, we attempt to predict human behavior. The research is done in various areas, such as retail, movies, polls etc. 

## 1.1 The Chanllenge 
Today, I follow many processors and will build a recommendation system for movies. The model will predict what rating the exsiting user will give for a movie that he/she never watched before.

## 1.2 Dataset: MovieLens
I will use **MovieLens** as our dataset. The dataset is generated by GroupLens reseach lab. You can download the data through the [link](http://files.grouplens.org/datasets/movielens/ml-10m.zip).

```{r MovieLens head,echo=FALSE}
head(edx,5)
```

## 1.3 Goal
I will find a consice and yet accurate model. The project is aimed at an RMSE that is less than 0.865. The project is also aimed to produce an easy-to-follow and reproducible report. 

# 2 Analysis
Before modeling, I create two dataset: **edx** and **validation**. The **validation** is 10% of the full dataset, and is only used for final assessement of the model. It won't be used for anywhere else in the project. The **edx** data is going to be split into two subset, **train_set** and **test_set**.

## 2.1 The Simplest Model
The simplest model,  y_i=mu+e_i

```{r, echo=FALSE}
RMSE <- function(true_ratings,predicted_ratings){
  sqrt(mean((true_ratings-predicted_ratings)^2))
}
```

```{r}
mu<-mean(train_set$rating)
rmse_simplest_model <- RMSE(mu,test_set$rating)
```

### Performance

```{r,echo=FALSE}
rmse_results <- data.frame(method="Average",RMSE=rmse_simplest_model)
```

```{r}
rmse_results
```


### Pros
This modle is the simplest model.

### Cons
The histogram shows that majority of the movies have residual more than 1.

The scatter plot shows that the residual converts to 1 as the rating count increase.In other words, the more rating for a movie doesn't increase the prediction accuracy with this model.

Therefore, I need to consider movie as a factor for the next model.

```{r, echo=FALSE}
temp_p <- test_set %>% mutate(residul=(rating-mu)^2) %>% group_by(movieId) %>% 
  summarise(r=sqrt(mean(residul)),count=n()) 

temp_p  %>% 
  ggplot(aes(r))+geom_histogram(bins=20)+labs(x="Residual",y="Movie Count",title="Histogram Movie Count vs Residual")+  geom_vline(xintercept=1)

mean(temp_p$r>1)

 temp_p%>% 
  ggplot(aes(count,r))+geom_point() +labs(x="Rating Count by Movie",y="Residual",title="Scatter Plot Residual vs Rating Count ")

```
The histogram shows that majority of the users have residual more than 1

The scatter plot shows that the residual converts to 1 as the rating count increase.In other words, the more ratings from a user don't increase the prediction accuracy with this model. 

Therefore, I need to consider user as a factor for the next model.

```{r,echo=FALSE}
temp_p <- test_set %>% mutate(residul=(rating-mu)^2) %>% group_by(userId) %>% 
  summarise(r=sqrt(mean(residul)),count=n())

temp_p%>% 
  ggplot(aes(r))+geom_histogram(bins=20)+labs(x="Residual",y="User Count",title="Histogram User Count vs Residual")+  geom_vline(xintercept=1)

mean(temp_p$r>1)

temp_p %>% 
  ggplot(aes(count,r))+geom_point() +labs(x="Rating Count per User",y="Residual",title="Scatter Plot Residual vs Rating Count")

```


## 2.2 Model 2

The model that consider movie and user average rating,  y_ij=mu+m_i+u_i+e_ij.
m_i is average of the ratings for movie i. u_j is the average of the ratings
for movie j. eij is the random error of rating of movie i from user j.

```{r}
movie_avgs <- train_set %>% group_by(movieId) %>% 
  summarise(m_i=mean(rating-mu))

user_avgs <- train_set %>% left_join(movie_avgs,by="movieId") %>% 
  group_by(userId) %>% 
  summarise(u_i=mean(rating-mu-m_i))

predicted_rating <- test_set %>% left_join(movie_avgs,by="movieId") %>% 
  left_join(user_avgs,by="userId") %>% mutate(predicted_rating=mu+m_i+u_i) %>% 
  .$predicted_rating
rmse_MovieAndUserAverage <- RMSE(predicted_rating,test_set$rating)
```

```{r,echo=FALSE}
rmse_results <- rbind(rmse_results,
                      data.frame(method="Add Movie and User Average",RMSE=rmse_MovieAndUserAverage))
```


### Performance
The RMSE increase from to . The accuracy improves siginificantly. But it does
not reach my goal yet. 

```{r,echo=FALSE}
rmse_results
```

### Pros
The histogram shows that majority of the movies have residual less than 1.Thus, adding the movie factor improves the result.

```{r movie,echo=FALSE}
#by movie
temp_p <- test_set %>% left_join(movie_avgs,by="movieId") %>%
  left_join(user_avgs,by="userId") %>%
  mutate(predicted_rating=mu+m_i+u_i) %>%
  mutate(residul=(rating-predicted_rating)^2) %>%
  group_by(movieId) %>%
  summarise(r=sqrt(mean(residul)),count=n())
```
```{r movie histogram,echo=FALSE}
temp_p%>%
  ggplot(aes(r))+geom_histogram(bins=20)+labs(x="Residual",y="Movie Count",title="Histogram Movie Count vs Residual")+geom_vline(xintercept=1)

mean(temp_p$r>1)

```

The histogram shows that majority of the users have residual less than 1.Thus, adding the user factor improves the result.

```{r}
#by user
temp_p <- test_set %>% left_join(movie_avgs,by="movieId") %>%
  left_join(user_avgs,by="userId") %>%
  mutate(predicted_rating=mu+m_i+u_i) %>%
  mutate(residul=(rating-predicted_rating)^2) %>%
  group_by(userId) %>%
  summarise(r=sqrt(mean(residul)),count=n())

temp_p%>%
  ggplot(aes(r))+geom_histogram()+labs(x="Residual",y="User Count",title="Histogram User Count vs Residual")+geom_vline(xintercept=1)

mean(temp_p$r>1)
```

### Cons

The bar chat shows that all the genres have residual greater than 1.

The scatter plot shows that the residual doesn't decrease as the rating count increase.In other words, the more ratings for a genre don't increase the prediction accuracy with this model.

Therefore, I need to consider the genre as a factor in the model 3.


```{r genres bar chart and scatter plot,echo=FALSE}
temp_p <- test_set %>% mutate(residul=(rating-mu)^2) %>% 
separate_rows(genres, sep = "\\|") %>% 
group_by(genres) %>% 
  summarise(r=sqrt(mean(residul)),count=n()) 

temp_p%>% ggplot(aes(genres,r))+geom_bar(stat = "identity") +
  labs(x="Genres",y="Residual",title="Bar Chart Residual vs Genres")+
  geom_text(aes(label=round(r,3)),size=3,check_overlap = TRUE,position=position_dodge(width=0.9), vjust=-0.25)+theme(axis.text.x = element_text(angle = 90, hjust = 1))


temp_p%>%  ggplot(aes(count,r))+geom_point() +
  labs(x="Rating Count per Genres",y="Residual",title="Scatter Plot Residual vs Rating Count")

```


## 2.3 Model 3
### Performance
### Pros
### Cons


# 3 Results

```{r load the validation dataset,echo=FALSE}
load("../rda/validation.rda")
```


## Model Summary

# 4 Conclusion

## Summary of the report
## Limitations
## Future Works

# 5 Reference

1 [R Markdown Cheat Sheet](https://rstudio.com/wp-content/uploads/2015/02/rmarkdown-cheatsheet.pdf)
2 [Data Science Courses from HarvardX](https://courses.edx.org/)
